// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENTE
  ASISTENTE
  GERENTE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING_VERIFICATION
  BLOCKED
}

model User {
  id                String      @id @default(uuid())
  email             String      @unique
  password          String
  fullName          String      @map("full_name")
  role              UserRole
  status            UserStatus  @default(PENDING_VERIFICATION)
  
  // Datos adicionales para CLIENTE
  cedula            String?     @unique
  telefono          String?
  direccion         String?
  
  // Control de acceso
  loginAttempts     Int         @default(0) @map("login_attempts")
  lastLoginAttempt  DateTime?   @map("last_login_attempt")
  blockedUntil      DateTime?   @map("blocked_until")
  lastLogin         DateTime?   @map("last_login")
  
  // Verificación email
  emailVerified     Boolean     @default(false) @map("email_verified")
  emailVerifiedAt   DateTime?   @map("email_verified_at")
  verificationToken String?     @map("verification_token")
  
  // Recuperación de contraseña
  resetToken        String?     @map("reset_token")
  resetTokenExpiry  DateTime?   @map("reset_token_expiry")
  
  // Auditoría
  createdAt         DateTime    @default(now()) @map("created_at")
  createdBy         String?     @map("created_by")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  
  // Relaciones
  refreshTokens     RefreshToken[]
  auditLogs         AuditLog[]
  
  @@map("users")
  @@index([email])
  @@index([cedula])
  @@index([role])
  @@index([status])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("refresh_tokens")
  @@index([token])
  @@index([userId])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  module    String
  details   Json?
  ipAddress String   @map("ip_address")
  userAgent String   @map("user_agent")
  status    String   // SUCCESS, FAILURE, WARNING
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}